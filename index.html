<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Image Password System</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }
      .container {
        display: flex;
        gap: 20px;
      }
      .panel {
        flex: 1;
        border: 1px solid #ccc;
        border-radius: 8px;
        padding: 16px;
        background-color: #f9f9f9;
      }
      h1 {
        color: #333;
        text-align: center;
      }
      h2 {
        color: #555;
      }
      button {
        background-color: #4caf50;
        color: white;
        padding: 10px 15px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-top: 10px;
      }
      button:hover {
        background-color: #45a049;
      }
      #message {
        margin-top: 20px;
        padding: 10px;
        border-radius: 4px;
        font-weight: bold;
      }
      .success {
        background-color: #dff0d8;
        color: #3c763d;
      }
      .error {
        background-color: #f2dede;
        color: #a94442;
      }
      .info {
        background-color: #d9edf7;
        color: #31708f;
      }
    </style>
  </head>
  <body>
    <h1>Image Password System</h1>
    <p>
      This system allows you to use an image as a password. Even if the filename
      or format changes, as long as the visual content is the same, the system
      will recognize it.
    </p>

    <div class="container">
      <div class="panel">
        <h2>Register Image</h2>
        <p>Select an image to use as your password:</p>
        <input type="file" id="registerImage" accept="image/*" />
        <button id="registerButton">Register Image</button>
      </div>

      <div class="panel">
        <h2>Verify Image</h2>
        <p>Test your image-based authentication:</p>
        <input type="file" id="verifyImage" accept="image/*" />
        <button id="verifyButton">Verify Image</button>
      </div>
    </div>

    <div id="message" class="info">Welcome to the Image Password System!</div>

    <script>
      // Image Password System
      class ImagePasswordSystem {
        constructor() {
          this.canvas = document.createElement("canvas");
          this.ctx = this.canvas.getContext("2d");
        }

        // Generate a perceptual hash for the image
        async generateImageHash(imageFile) {
          try {
            // Load the image
            const image = await this.loadImage(imageFile);

            // Resize to small dimensions to normalize the image
            this.canvas.width = 8;
            this.canvas.height = 8;

            // Draw the image in grayscale
            this.ctx.filter = "grayscale(100%)";
            this.ctx.drawImage(image, 0, 0, 8, 8);

            // Get pixel data
            const pixelData = this.ctx.getImageData(0, 0, 8, 8).data;

            // Calculate average pixel value
            let sum = 0;
            for (let i = 0; i < pixelData.length; i += 4) {
              sum += pixelData[i]; // Just using red channel since image is grayscale
            }
            const avg = sum / (pixelData.length / 4);

            // Generate binary hash based on whether pixel is above or below average
            let hash = "";
            for (let i = 0; i < pixelData.length; i += 4) {
              hash += pixelData[i] >= avg ? "1" : "0";
            }

            // Convert binary hash to hex for easier use
            const hexHash = this.binaryToHex(hash);

            return hexHash;
          } catch (error) {
            console.error("Error generating image hash:", error);
            throw error;
          }
        }

        // Load an image from a file
        loadImage(file) {
          return new Promise((resolve, reject) => {
            const reader = new FileReader();

            reader.onload = (event) => {
              const img = new Image();
              img.onload = () => resolve(img);
              img.onerror = () => reject(new Error("Failed to load image"));
              img.src = event.target.result;
            };

            reader.onerror = () => reject(new Error("Failed to read file"));
            reader.readAsDataURL(file);
          });
        }

        // Convert binary string to hexadecimal
        binaryToHex(binary) {
          let hex = "";
          for (let i = 0; i < binary.length; i += 4) {
            const chunk = binary.substr(i, 4);
            hex += parseInt(chunk, 2).toString(16);
          }
          return hex;
        }

        // Generate a password from the image hash
        generatePassword(hash) {
          // Create a more secure password by applying SHA-256 to the hash
          return this.sha256(hash);
        }

        // Simple implementation of SHA-256
        async sha256(message) {
          const encoder = new TextEncoder();
          const data = encoder.encode(message);
          const hashBuffer = await crypto.subtle.digest("SHA-256", data);
          const hashArray = Array.from(new Uint8Array(hashBuffer));
          const hashHex = hashArray
            .map((b) => b.toString(16).padStart(2, "0"))
            .join("");
          return hashHex;
        }

        // Verify if an image matches the stored password
        async verifyImagePassword(imageFile, storedHash) {
          const hash = await this.generateImageHash(imageFile);
          const password = await this.generatePassword(hash);
          return password === storedHash;
        }
      }

      // Application logic
      const app = {
        imagePasswordSystem: new ImagePasswordSystem(),
        storedPassword: null,

        init() {
          // Set up event listeners
          document
            .getElementById("registerButton")
            .addEventListener("click", this.registerImage.bind(this));
          document
            .getElementById("verifyButton")
            .addEventListener("click", this.verifyImage.bind(this));
        },

        async registerImage() {
          const fileInput = document.getElementById("registerImage");
          if (fileInput.files.length === 0) {
            this.showMessage("Please select an image to register", "error");
            return;
          }

          try {
            const file = fileInput.files[0];
            const hash = await this.imagePasswordSystem.generateImageHash(file);
            this.storedPassword =
              await this.imagePasswordSystem.generatePassword(hash);

            this.showMessage(
              `Image registered! Generated password: ${this.storedPassword.substring(
                0,
                10
              )}...`,
              "success"
            );
          } catch (error) {
            this.showMessage(`Error: ${error.message}`, "error");
          }
        },

        async verifyImage() {
          const fileInput = document.getElementById("verifyImage");
          if (fileInput.files.length === 0) {
            this.showMessage("Please select an image to verify", "error");
            return;
          }

          if (!this.storedPassword) {
            this.showMessage("Please register an image first", "info");
            return;
          }

          try {
            const file = fileInput.files[0];
            const isMatch = await this.imagePasswordSystem.verifyImagePassword(
              file,
              this.storedPassword
            );

            if (isMatch) {
              this.showMessage(
                "Success! The image matches the registered image.",
                "success"
              );
            } else {
              this.showMessage(
                "Authentication failed. The image does not match.",
                "error"
              );
            }
          } catch (error) {
            this.showMessage(`Error: ${error.message}`, "error");
          }
        },

        showMessage(message, type) {
          const messageElement = document.getElementById("message");
          messageElement.textContent = message;
          messageElement.className = type;
        },
      };

      // Initialize the app when the DOM is loaded
      document.addEventListener("DOMContentLoaded", () => {
        app.init();
      });
    </script>
  </body>
</html>
